<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>La Prairie Pluvieuse - VR</title>
    <meta
      name="description"
      content="Environnement VR immersif avec physique"
    />

    <!-- 1. IMPORT A-FRAME & LIBRARIES -->
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <!-- A-Frame Extras (Animation, Controls, etc.) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>

    <!-- Physics System (Ammo Driver) -->
    <!-- Note: Ammo.js wasm loader config usually handled by aframe-physics-system, but explicit load can be safer -->
    <script src="https://cdn.jsdelivr.net/gh/MozillaReality/ammo.js@8bbc0ea/builds/ammo.wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>

    <!-- Teleport Controls -->
    <script src="https://rawgit.com/fernsroth/aframe-teleport-controls/master/dist/aframe-teleport-controls.min.js"></script>

    <!-- Custom User Scripts -->
    <!-- Custom User Scripts -->
    <script src="./assets/js/christmas-utils.js"></script>
    <script src="./assets/js/christmas-utils.js"></script>
    <!-- Script introuvable : <script src="./research/physics-ammo/move-objects-ph3.js"></script> -->

    <script>
      // Configuration simple pour la pluie (sera lancée plus bas)
      AFRAME.registerComponent("rain-drop", {
        init: function () {
          this.reset();
        },
        tick: function () {
          this.el.object3D.position.y -= 0.1;
          if (this.el.object3D.position.y < 0) {
            this.reset();
          }
        },
        reset: function () {
          // Position aléatoire autour du joueur (zone 20x20)
          var x = (Math.random() - 0.5) * 20;
          var z = (Math.random() - 0.5) * 20;
          var y = 10 + Math.random() * 5;
          this.el.object3D.position.set(x, y, z);
        },
      });

      // FIX PHYSICS: Enable CCD to prevent tunneling
      AFRAME.registerComponent("fix-physics", {
        init: function () {
          this.el.addEventListener("body-loaded", (e) => {
            const body = e.detail.body;
            if (body) {
              body.setCcdMotionThreshold(1e-7);
              body.setCcdSweptSphereRadius(0.02);
            }
          });
        },
      });

      // SLEEPY: Force object to sleep until touched/grabbed
      // This prevents them from falling through the floor on load
      AFRAME.registerComponent("sleepy", {
        init: function () {
          this.el.addEventListener("body-loaded", (e) => {
            const body = e.detail.body;
            if (body) {
              // 2 = ISLAND_SLEEPING (Ammo.js)
              body.setActivationState(2);
            }
          });
        },
      });

      // AI WILDEBEEST
      AFRAME.registerComponent("wildebeest-ai", {
        init: function () {
            this.direction = new THREE.Vector3(0, 0, 1);
            this.speed = 0.02;
            // Enclos Local Coordinates Approx: X[0..8], Z[0..8]
            // We assume the entity is child of enclosArea (10,0,-15)
            // So world coords: X[10..18], Z[-15..-7]
            this.turnTimer = 0;
        },
        tick: function () {
            // Move forward (Negative Z is forward in WebGL/A-Frame)
            this.el.object3D.translateZ(-this.speed);

            this.turnTimer++;
            
            // Random turn every now and then
            if (this.turnTimer > 200 + Math.random() * 500) {
                this.turn();
            }

            // Boundary Check (Local to parent Enclosure)
            // New 8x8m enclosure centered at (0,0,4) roughly
            // Bounds: X [-3.5, 3.5], Z [0.5, 7.5]
            var pos = this.el.object3D.position;
            if (pos.x < -3.5 || pos.x > 3.5 || pos.z < 0.5 || pos.z > 7.5) {
                // Too close to fence, turn around!
                this.el.object3D.rotation.y += Math.PI + (Math.random() - 0.5);
                // Clamp position
                pos.x = Math.max(-3.4, Math.min(3.4, pos.x));
                pos.z = Math.max(0.6, Math.min(7.4, pos.z));
                this.turnTimer = 0;
            }
        },
        turn: function() {
            this.el.object3D.rotation.y += (Math.random() - 0.5) * 2;
            this.turnTimer = 0;
        }
      });

      // CAT AI - Linear Patrol (Back and Forth)
      AFRAME.registerComponent("cat-ai", {
        init: function () {
            this.speed = 0.02; // Faster
            this.maxDist = 5;  // 5 meters range
            this.startPos = this.el.object3D.position.clone();
            // Start moving forward?
        },
        tick: function () {
            // Move forward (Positive Z seems to be forward for this specific model)
            this.el.object3D.translateZ(this.speed);
            
            // Check distance from start
            var dist = this.el.object3D.position.distanceTo(this.startPos);
            if (dist > this.maxDist) {
                // Turn 180 degrees
                this.el.object3D.rotation.y += Math.PI;
                // Reset/Clamp slightly to prevent getting stuck if logic overshoots
                // But simple rotation is enough, it will walk back
            }
        }
      });
    </script>
  </head>
  <body>
    <!-- Config Scene avec Physique Ammo (DEBUG DISABLED) -->
    <a-scene
      physics="driver: ammo; debug: false; gravity: -9.8"
      renderer="antialias: false; colorManagement: true; sortObjects: true"
    >
      <!-- 2. ASSETS -->
      <a-assets>
        <!-- Texture Sol Réaliste (CDN Three.js) -->
        <img
          id="grassTexture"
          src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/terrain/grasslight-big.jpg"
        />

        <!-- Modèles 3D -->
        <a-asset-item
          id="grassModel"
          src="./assets/models/Grass.glb"
        ></a-asset-item>
        <a-asset-item
          id="barnModel"
          src="./assets/models/wooden_barn.glb"
        ></a-asset-item>
        <a-asset-item
          id="fenceModel"
          src="./assets/models/fence.glb"
        ></a-asset-item>
        <a-asset-item
          id="wildebeestModel"
          src="./assets/models/wildebeest.glb"
        ></a-asset-item>
        <a-asset-item
          id="treeModel"
          src="./assets/models/Tree.glb"
        ></a-asset-item>
        <a-asset-item
          id="bushModel"
          src="./assets/models/bush.glb"
        ></a-asset-item>
        <a-asset-item
          id="stickModel"
          src="./assets/models/Stick.glb"
        ></a-asset-item>
        <a-asset-item
          id="crateModel"
          src="./assets/models/Crate.glb"
        ></a-asset-item>
        <a-asset-item
          id="hatModel"
          src="./assets/models/hat.glb"
        ></a-asset-item>
        <a-asset-item
          id="sunModel"
          src="./assets/models/Sun.glb"
        ></a-asset-item>
        <a-asset-item
          id="chatModel"
          src="./assets/models/cat.glb"
        ></a-asset-item>
        <a-asset-item
          id="swingModel"
          src="./assets/models/balancoire.glb"
        ></a-asset-item>

        <!-- Mixins Physiques & Interactions -->
        <!-- Objet attrapable standard -->
        <a-mixin
          id="grabbable"
          ammo-shape="type: hull"
          ammo-body="type: dynamic; mass: 1"
        >
        </a-mixin>

        <a-mixin
          id="grassMixin"
          gltf-model="#grassModel"
          scale="0.1 0.1 0.1"
        ></a-mixin>

        <a-mixin
          id="stickMixin"
          gltf-model="#stickModel"
          scale="1 1 1"
          ammo-body="type: dynamic; mass: 1"
          ammo-shape="type: box; fit: manual; halfExtents: 0.05 0.05 0.5"
          fix-physics
        >
        </a-mixin>

        <a-mixin
          id="hatMixin"
          gltf-model="#hatModel"
          scale="1 1 1"
          ammo-body="type: dynamic; mass: 1"
          ammo-shape="type: box; fit: manual; halfExtents: 0.3 0.3 0.3"
          fix-physics
        >
        </a-mixin>

        <a-mixin
          id="coal"
          material="color:black"
          geometry="primitive:sphere; segments-height:7; segments-width:13; radius:0.1"
          ammo-shape="type: box; fit: manual; halfExtents: 0.1 0.1 0.1"
          ammo-body="type:dynamic; mass:0.1; linearDamping: 0.95; angularDamping: 0.95"
          fix-physics
        >
        </a-mixin>
        <a-mixin
          id="branch"
          material="color:#5C4033"
          geometry="primitive:branch"
          scale="0.2 0.2 0.2"
          ammo-shape="type: box; fit: manual; halfExtents: 0.3 0.1 0.1"
          ammo-body="type:dynamic; mass:0.1"
          fix-physics
        >
        </a-mixin>

        <!-- Mixin Arbre (Décor) -->
        <a-mixin
          id="treeMixin"
          gltf-model="#treeModel"
          scale="3 3 3"
          ammo-body="type: static"
          ammo-shape="type: cylinder"
        >
        </a-mixin>

        <!-- Mixin Bush (Petit buisson) -->
        <a-mixin
          id="bushMixin"
          gltf-model="#bushModel"
          scale="0.02 0.02 0.02"
          ammo-body="type: static"
          ammo-shape="type: box"
        >
        </a-mixin>
      </a-assets>

      <!-- 3. ENVIRONNEMENT -->
      <!-- Ciel Ensoleillé (Bleu pur) -->
      <a-sky color="#87CEEB"></a-sky>

      <!-- Soleil -->
      <a-entity
        gltf-model="#sunModel"
        position="-20 50 -30"
        scale="5 5 5"
      ></a-entity>

      <!-- Lumière -->
      <a-entity light="type: ambient; color: #FFF; intensity: 0.7"></a-entity>
      <a-entity
        light="type: directional; color: #FFF; intensity: 1; castShadow: false"
        position="-1 1 0.5"
      ></a-entity>

      <a-plane
        src="#grassTexture"
        rotation="-90 0 0"
        width="100"
        height="100"
        repeat="20 20"
        material="roughness: 1; metalness: 0"
      >
      </a-plane>

      <!-- SOLID PHYSICS FLOOR (Invisible Box) -->
      <!-- Positioned slightly below Y=0 (center at -0.5, height 1) so top face is at Y=0 -->
      <a-box
        id="physicsFloor"
        position="0 -0.5 0"
        width="100"
        height="1"
        depth="100"
        visible="false"
        ammo-body="type: static"
        ammo-shape="type: box"
      ></a-box>

      <!-- 4. ÉLÉMENTS SCÉNIQUES -->
      <!-- Hangar -->
      <a-entity
        gltf-model="#barnModel"
        position="-10 0 -15"
        scale="2 2 2"
        ammo-body="type: static"
        ammo-shape="type: box; fit: manual; halfExtents: 5 4 5; offset: 0 4 0"
      >
      </a-entity>

      <!-- Balançoire (Devant la maison) -->
      <!-- Réduite de 15% addtionnelle (0.02 * 0.85 = 0.017) -->
      <a-entity
        gltf-model="#swingModel"
        position="-10 0 -5"
        rotation="0 180 0"
        scale="0.017 0.017 0.017"
        ammo-body="type: static"
        ammo-shape="type: hull"
      ></a-entity>

      <!-- Enclos (Fence) - Moyen & Moyen Loin -->
      <!-- Position further back (2 0 -16) -->
      <a-entity position="2 0 -16" id="enclosArea">
        <!-- Carré de 8x8m (2 panneaux par côté) -->
        
        <!-- Façade (Z=0) covers X[-4, 4] -->
        <a-entity gltf-model="#fenceModel" position="-2 0 0" scale="1 0.9 1" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 0.6 0.2"></a-entity>
        <a-entity gltf-model="#fenceModel" position="2 0 0" scale="1 0.9 1" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 0.6 0.2"></a-entity>
        
        <!-- Arrière (Z=8) -->
        <a-entity gltf-model="#fenceModel" position="-2 0 8" scale="1 0.9 1" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 0.6 0.2"></a-entity>
        <a-entity gltf-model="#fenceModel" position="2 0 8" scale="1 0.9 1" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 0.6 0.2"></a-entity>
        
        <!-- Gauche (X=-4) covers Z[0, 8] -->
        <a-entity gltf-model="#fenceModel" position="-4 0 2" scale="1 0.9 1" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 0.6 0.2"></a-entity>
        <a-entity gltf-model="#fenceModel" position="-4 0 6" scale="1 0.9 1" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 0.6 0.2"></a-entity>
        
        <!-- Droite (X=4) -->
        <a-entity gltf-model="#fenceModel" position="4 0 2" scale="1 0.9 1" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 0.6 0.2"></a-entity>
        <a-entity gltf-model="#fenceModel" position="4 0 6" scale="1 0.9 1" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 0.6 0.2"></a-entity>

        <!-- 2 Gnous (Wildebeests) - Inside pen -->
        <a-entity
          id="gnou1"
          gltf-model="#wildebeestModel"
          position="0 0 4"
          scale="0.7 0.7 0.7"
          animation-mixer="clip: *walk*; loop: repeat; timeScale: 1.0"
          wildebeest-ai
        ></a-entity>
        <a-entity
          id="gnou2"
          gltf-model="#wildebeestModel"
          position="2 0 5"
          scale="0.7 0.7 0.7"
          animation-mixer="clip: *walk*; loop: repeat; timeScale: 0.9"
          wildebeest-ai
        ></a-entity>
      </a-entity>

      <!-- Végétation & Loot -->
      <a-entity position="0 0 0" id="vegetation"></a-entity>

      <!-- LE CHAT -->
      <!-- Scale 0.05. Rehaussé Y=0.15 pour ne pas être enterré -->
      <!-- PATROL AI: Linear walk with turn -->
      <a-entity
        gltf-model="#chatModel"
        position="-12 0 -11"
        scale="0.0020 0.0020 0.0020"
        rotation="0 90 0"
        animation-mixer="clip: *; loop: repeat; timeScale: 2.0"
        cat-ai
      ></a-entity>

      <!-- 5. LA CAISSE SPÉCIALE INTERACTIVE -->
      <a-entity position="-6 0 -11">
        <!-- Caisse en bois -->
        <a-entity
          gltf-model="#crateModel"
          id="mainCrate"
          scale="1 1 1"
          ammo-body="type: static"
          ammo-shape="type: box; fit: manual; halfExtents: 0.5 0.5 0.5; offset: 0 0.5 0"
          movement="type: static; stickiness: sticky"
          position="0 0 0"
        >
        </a-entity>

      </a-entity>
      
      <!-- Invisible Safety Tabletop for Crate (Ensures loot lands) -->
      <a-box
        color="red"
        visible="false"
        position="-6 0.9 -11"
        width="1.2"
        height="0.2"
        depth="1.2"
        ammo-body="type: static"
        ammo-shape="type: box"
      ></a-box>

      <!-- LOOT GLOBAL (Un-nested for physics stability) -->
      <!-- Crate World Pos: -6, 0, -11 -->
      
      <!-- Baton: Drop onto crate -->
      <a-entity
        mixin="stickMixin"
        position="-5.8 1.1 -10.9"
        rotation="90 0 45"
        ammo-body="type: dynamic; mass: 0.5"
        sleepy
      ></a-entity>
      
      <!-- Coal: Drop onto crate -->
      <a-entity 
        mixin="coal" 
        position="-6.0 1.1 -11.0" 
        ammo-body="type: dynamic; mass: 0.5; linearDamping: 0.95"
        sleepy
      ></a-entity>

      <!-- CHAPEAU AU SOL (DYNAMIC avec fix sol) -->
      <a-entity
          mixin="hatMixin"
          position="-5 0.3 -10"
          scale="0.2 0.2 0.2"
          ammo-body="type: dynamic; mass: 0.5"
          sleepy
      ></a-entity>

      <!-- 6. JOUEUR (RIG CAMERA) -->
      <!-- Kinematic body to interact with physics -->
      <!-- 6. JOUEUR (RIG CAMERA) -->
      <!-- NO PHYSICS BODY, pure simple camera rig -->
      <a-entity id="rig" position="0 0 0">
        <a-camera
          id="camera"
          position="0 1.6 0"
          look-controls="pointerLockEnabled: false"
        ></a-camera>
        
        <!-- Hands: Visual Only, No Interaction -->
        <a-entity
          id="lhand"
          hand-controls="hand: left"
          visible="true"
        ></a-entity>
        <a-entity
          id="rhand"
          hand-controls="hand: right"
          visible="true"
        ></a-entity>
      </a-entity>
    </a-scene>

    <!-- Script de génération procédurale & Animation -->
    <script>
      // Génération Pluie
      function createRain() {
        var scene = document.querySelector("a-scene");
        var rainCount = 200; // OPTIMISATION : Grosses économies CPU/GPU
        for (var i = 0; i < rainCount; i++) {
          var drop = document.createElement("a-entity");
          drop.setAttribute(
            "geometry",
            "primitive: box; height: 0.1; width: 0.01; depth: 0.01"
          );
          drop.setAttribute(
            "material",
            "color: #AACCFF; opacity: 0.6; transparent: true"
          );
          drop.setAttribute("rain-drop", "");
          scene.appendChild(drop);
        }
      }

      // Végétation (Arbres Decor & Bush Sol)
      function createVegetation() {
        var container = document.querySelector("#vegetation");

        // 1. ARBRES (Décor Naturel autour)
        // On veut une disposition aléatoire mais qui laisse le centre (Maison/Enclos) dégagé.
        // Centre approximatif de la zone de vie : x=0, z=-10
        var treeCount = 32;
        var trees = [];

        for (var i = 0; i < treeCount; i++) {
          var valid = false,
            attempts = 0;
          var x, z;

          while (!valid && attempts < 50) {
            // Zone large de 80x80
            x = (Math.random() - 0.5) * 80;
            z = (Math.random() - 0.5) * 80; // Centré autour de 0,0

            // Calcul distance au centre de la zone de vie (0, -10)
            var dist = Math.sqrt((x - 0) ** 2 + (z - -10) ** 2);

            // REGLE : On veut les arbres LOIN du centre (> 25m) et pas trop proches les uns des autres
            if (dist > 25) {
              valid = true;
              // Check anti-collision entre arbres
              for (var t = 0; t < trees.length; t++) {
                if (Math.hypot(x - trees[t].x, z - trees[t].z) < 5) {
                  valid = false;
                  break;
                }
              }
            }
            attempts++;
          }

          if (valid) {
            trees.push({ x: x, z: z });
            var tree = document.createElement("a-entity");
            tree.setAttribute("mixin", "treeMixin");
            // Scale augmenté ENCORE de 30% (Total: 1.69)
            var s = (1.0 + Math.random() * 1.5) * 3;
            // CORRECTION: position Y levée selon le scale (approx pivot centré)
            tree.setAttribute("position", { x: x, y: s * 1, z: z });
            tree.setAttribute("scale", { x: s, y: s, z: s });
            tree.setAttribute("rotation", {
              x: 0,
              y: Math.random() * 360,
              z: 0,
            });
            container.appendChild(tree);
          }
        }

        // 2. BUSHES (Buissons au sol aléatoires)
        // Ils peuvent être un peu plus proches, pour habiller le sol
        var bushCount = 80; // OPTIMISATION
        var isForbidden = function (x, z) {
          // Zone stricte maison/enclos pour ne pas clipper dedans
          // (x: -12 à 20, z: -20 à -5)
          return x > -12 && x < 20 && z > -20 && z < -5;
        };

        for (var k = 0; k < bushCount; k++) {
          var x = (Math.random() - 0.5) * 70;
          var z = (Math.random() - 0.5) * 70;

          if (!isForbidden(x, z)) {
            var bush = document.createElement("a-entity");
            bush.setAttribute("mixin", "bushMixin");
            bush.setAttribute("position", { x: x, y: 0, z: z });
            // Scale augmenté car 0.02 était invisible.
            // On tente 0.5 à 0.8
            var s = 0.5 + Math.random() * 0.5;
            bush.setAttribute("scale", { x: s, y: s, z: s });
            bush.setAttribute("rotation", {
              x: 0,
              y: Math.random() * 360,
              z: 0,
            });
            container.appendChild(bush);
          }
        }

        // 3. Herbe & Batons
        var grassCount = 150; // OPTIMISATION
        for (var j = 0; j < grassCount; j++) {
          var angleG = Math.random() * Math.PI * 2;
          var radiusG = 2 + Math.random() * 45;
          var xG = Math.cos(angleG) * radiusG;
          var zG = Math.sin(angleG) * radiusG;
          var grass = document.createElement("a-entity");
          grass.setAttribute("mixin", "grassMixin");
          grass.setAttribute("position", { x: xG, y: 0, z: zG });
          grass.setAttribute("rotation", {
            x: 0,
            y: Math.random() * 360,
            z: 0,
          });
        // Batons, Coals, Hats supprimés de la génération procédurale
        // (Placement manuel uniquement sur demande)
      }
    } // End of createVegetation

      // Lancement au chargement
      window.addEventListener("load", function () {
        createRain();
        createVegetation();
      });
    </script>
  </body>
</html>

