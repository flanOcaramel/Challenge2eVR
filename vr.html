<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>La Prairie Pluvieuse - VR</title>
    <meta name="description" content="Environnement VR immersif avec physique">
    
    <!-- 1. IMPORT A-FRAME & LIBRARIES -->
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    
    <!-- A-Frame Extras (Animation, Controls, etc.) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>

    <!-- Physics System (Ammo Driver) -->
    <script src="https://cdn.jsdelivr.net/gh/MozillaReality/ammo.js@8bbc0ea/builds/ammo.wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
    
    <!-- REMOVED: teleport-controls (ancienne tentative) -->

    <!-- Custom User Scripts -->
    <script src="./assets/js/christmas-utils.js"></script>

    <!-- Our new components -->
    <script src="./src/components/teleport-arc.js"></script>
    <script src="./src/components/grab-throw.js"></script>

    <script>
        // Configuration simple pour la pluie (sera lancée plus bas)
        AFRAME.registerComponent('rain-drop', {
            init: function() {
                this.reset();
            },
            tick: function() {
                this.el.object3D.position.y -= 0.1;
                if (this.el.object3D.position.y < 0) {
                    this.reset();
                }
            },
            reset: function() {
                var x = (Math.random() - 0.5) * 20;
                var z = (Math.random() - 0.5) * 20;
                var y = 10 + Math.random() * 5;
                this.el.object3D.position.set(x, y, z);
            }
        });
    </script>
</head>
<body>
    <!-- Scene with Ammo physics -->
    <a-scene 
        physics="driver: ammo; debug: false; gravity: -9.8"
        renderer="antialias: false; colorManagement: true; sortObjects: true">

        <!-- 2. ASSETS -->
        <a-assets>
            <img id="grassTexture" src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/terrain/grasslight-big.jpg">
            
            <a-asset-item id="grassModel" src="./assets/models/Grass.glb"></a-asset-item>
            <a-asset-item id="barnModel" src="./assets/models/wooden_barn.glb"></a-asset-item>
            <a-asset-item id="fenceModel" src="./assets/models/fence.glb"></a-asset-item>
            <a-asset-item id="wildebeestModel" src="./assets/models/wildebeest.glb"></a-asset-item>
            <a-asset-item id="treeModel" src="./assets/models/Tree.glb"></a-asset-item>
            <a-asset-item id="bushModel" src="./assets/models/bush.glb"></a-asset-item>
            <a-asset-item id="stickModel" src="./assets/models/Stick.glb"></a-asset-item>
            <a-asset-item id="crateModel" src="./assets/models/Crate.glb"></a-asset-item>
            <a-asset-item id="hatModel" src="./assets/models/hat.glb"></a-asset-item>
            <a-asset-item id="sunModel" src="./assets/models/Sun.glb"></a-asset-item>
            <a-asset-item id="chatModel" src="./assets/models/chat.glb"></a-asset-item>
            <a-asset-item id="swingModel" src="./assets/models/balancoire.glb"></a-asset-item>

            <!-- MIXINS SIMPLIFIÉS / compatibles Ammo -->
            <!-- Mixin d'objets attrapables (classe + ammo-body) -->
            <a-mixin id="grabbable"
                     class="grabbable"
                     ammo-shape="type: hull"
                     ammo-body="type: dynamic; mass: 1">
            </a-mixin>

            <a-mixin id="grassMixin" gltf-model="#grassModel" scale="0.1 0.1 0.1"></a-mixin>

            <a-mixin id="stickMixin"
                     mixin="grabbable"
                     gltf-model="#stickModel"
                     scale="1 1 1">
            </a-mixin>

            <a-mixin id="hatMixin"
                     mixin="grabbable"
                     gltf-model="#hatModel"
                     scale="1 1 1">
            </a-mixin>

            <a-mixin id="coal"
                     class="grabbable"
                     material="color:black" 
                     geometry="primitive:sphere; segments-height:7; segments-width:13; radius:0.04"
                     ammo-shape="type:sphere; fit:manual; sphereRadius:0.04"
                     ammo-body="type:dynamic; mass:0.1">
            </a-mixin>

            <a-mixin id="branch"
                     class="grabbable"
                     material="color:#5C4033" 
                     geometry="primitive:box" scale="0.2 0.2 0.2"
                     ammo-shape="type:hull"
                     ammo-body="type:dynamic; mass:0.1">
            </a-mixin>

            <a-mixin id="treeMixin"
                     gltf-model="#treeModel"
                     scale="3 3 3"
                     ammo-body="type: static" 
                     ammo-shape="type: cylinder">
            </a-mixin>

            <a-mixin id="bushMixin"
                     gltf-model="#bushModel"
                     scale="0.02 0.02 0.02" 
                     ammo-body="type: static" 
                     ammo-shape="type: box">
            </a-mixin>
        </a-assets>

        <!-- 3. ENVIRONNEMENT -->
        <a-sky color="#87CEEB"></a-sky>
        <a-entity gltf-model="#sunModel" position="-20 50 -30" scale="5 5 5"></a-entity>
        <a-entity light="type: ambient; color: #FFF; intensity: 0.7"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 1; castShadow: false" position="-1 1 0.5"></a-entity>

        <!-- Ground : rendu + physics + teleportable -->
        <a-plane 
            class="teleportable"
            src="#grassTexture"
            rotation="-90 0 0" 
            width="100" 
            height="100" 
            repeat="20 20"
            material="roughness: 1; metalness: 0"
            ammo-body="type: static" 
            ammo-shape="type: box">
        </a-plane>

        <!-- 4. ÉLÉMENTS SCÉNIQUES -->
        <a-entity gltf-model="#barnModel" position="-10 0 -15" scale="2 2 2" 
            ammo-body="type: static" 
            ammo-shape="type: box; fit: manual; halfExtents: 5 4 5; offset: 0 4 0">
        </a-entity>

        <a-entity gltf-model="#swingModel" position="-10 0 -5" rotation="0 180 0" scale="0.017 0.017 0.017"
             ammo-body="type: static" ammo-shape="type: hull"></a-entity>

        <a-entity position="10 0 -15" id="enclosArea">
            <a-entity gltf-model="#fenceModel" position="0 0 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="4 0 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="8 0 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="0 0 8" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="4 0 8" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="8 0 8" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>

            <!-- Gnous (exemples) -->
            <a-entity id="gnou1" gltf-model="#wildebeestModel" position="4 0 4" scale="0.7 0.7 0.7" animation-mixer="clip: *walk*; loop: repeat; timeScale: 1.0"></a-entity>
            <a-entity id="gnou2" gltf-model="#wildebeestModel" position="5 0 5" scale="0.7 0.7 0.7" animation-mixer="clip: *walk*; loop: repeat; timeScale: 0.9"></a-entity>
            <a-entity id="gnou3" gltf-model="#wildebeestModel" position="3 0 5" scale="0.7 0.7 0.7" animation-mixer="clip: *walk*; loop: repeat; timeScale: 1.1"></a-entity>
            <a-entity id="gnou4" gltf-model="#wildebeestModel" position="5 0 3" scale="0.7 0.7 0.7" animation-mixer="clip: *walk*; loop: repeat; timeScale: 1.05"></a-entity>
            <a-entity id="gnou5" gltf-model="#wildebeestModel" position="3 0 3" scale="0.7 0.7 0.7" animation-mixer="clip: *walk*; loop: repeat; timeScale: 0.95"></a-entity>
        </a-entity>

        <a-entity position="0 0 0" id="vegetation"></a-entity>

        <a-entity gltf-model="#chatModel" position="-12 0.50 -11" scale="0.02 0.02 0.02" rotation="0 45 0" 
                  ammo-body="type: static" ammo-shape="type: hull"></a-entity>

        <!-- 5. CAISSE & LOOT -->
        <a-entity position="-6 0 -11"> 
            <a-entity gltf-model="#crateModel" 
                id="mainCrate"
                scale="1 1 1"
                ammo-body="type: static" 
                ammo-shape="type: box"
                position="0 0 0">
            </a-entity>

            <a-entity mixin="hatMixin" position="0 1.0 0" scale="0.2 0.2 0.2"></a-entity>
            <a-entity mixin="stickMixin" position="0.5 1.0 0.2" rotation="0 90 0"></a-entity>
            <a-entity mixin="coal" position="-0.3 1.05 0.2"></a-entity>
            <a-entity mixin="branch" position="0.3 1.02 -0.2" rotation="90 0 0"></a-entity>
        </a-entity>

        <!-- 6. JOUEUR (RIG CAMERA) -->
        <a-entity id="rig">
            <a-camera id="camera" position="0 1.6 0" look-controls wasd-controls></a-camera>

            <!-- Left controller: teleport arc (gâchette gauche) -->
            <a-entity id="lhand"
                      hand-controls="hand: left"
                      teleport-arc="rig: #rig; landingClass: teleportable"
                      visible="true">
            </a-entity>

            <!-- Right controller: grab & throw (gâchette droite) -->
            <a-entity id="rhand"
                      hand-controls="hand: right"
                      grab-throw
                      visible="true">
            </a-entity>
        </a-entity>
    
    </a-scene>

    <!-- Script de génération procédurale & Animation -->
    <script>
        function createRain() {
            var scene = document.querySelector('a-scene');
            var rainCount = 200;
            for(var i=0; i<rainCount; i++) {
                var drop = document.createElement('a-entity');
                drop.setAttribute('geometry', 'primitive: box; height: 0.1; width: 0.01; depth: 0.01');
                drop.setAttribute('material', 'color: #AACCFF; opacity: 0.6; transparent: true');
                drop.setAttribute('rain-drop', '');
                scene.appendChild(drop);
            }
        }
        
        function createVegetation() {
            var container = document.querySelector('#vegetation');
            var treeCount = 32;
            var trees = [];
            
            for(var i=0; i<treeCount; i++) {
                var valid = false, attempts = 0;
                var x, z;
                while(!valid && attempts < 50) {
                    x = (Math.random() - 0.5) * 80;
                    z = (Math.random() - 0.5) * 80;
                    var dist = Math.sqrt((x - 0)**2 + (z - -10)**2);
                    if(dist > 25) { 
                        valid = true;
                        for(var t=0; t<trees.length; t++) {
                            if(Math.hypot(x-trees[t].x, z-trees[t].z) < 5) { valid = false; break; }
                        }
                    }
                    attempts++;
                }

                if(valid) {
                    trees.push({x:x, z:z});
                    var tree = document.createElement('a-entity');
                    tree.setAttribute('mixin', 'treeMixin');
                    var s = (1.0 + Math.random() * 1.5) * 3; 
                    tree.setAttribute('position', {x: x, y: s * 1, z: z});
                    tree.setAttribute('scale', {x: s, y: s, z: s});
                    tree.setAttribute('rotation', {x: 0, y: Math.random()*360, z: 0});
                    container.appendChild(tree);
                }
            }

            var bushCount = 80;
            var isForbidden = function(x, z) {
                return (x > -12 && x < 20 && z > -20 && z < -5);
            };

            for(var k=0; k<bushCount; k++) {
                var x = (Math.random() - 0.5) * 70;
                var z = (Math.random() - 0.5) * 70;
                
                if(!isForbidden(x,z)) {
                   var bush = document.createElement('a-entity');
                   bush.setAttribute('mixin', 'bushMixin');
                   bush.setAttribute('position', {x: x, y: 0, z: z});
                   var s = 0.5 + Math.random() * 0.5; 
                   bush.setAttribute('scale', {x: s, y: s, z: s});
                   bush.setAttribute('rotation', {x: 0, y: Math.random()*360, z: 0});
                   container.appendChild(bush);
                }
            }

            var grassCount = 150;
            for(var j=0; j<grassCount; j++) {
                var angleG = Math.random() * Math.PI * 2;
                var radiusG = 2 + Math.random() * 45; 
                var xG = Math.cos(angleG) * radiusG;
                var zG = Math.sin(angleG) * radiusG;
                var grass = document.createElement('a-entity');
                grass.setAttribute('mixin', 'grassMixin');
                grass.setAttribute('position', {x: xG, y: 0, z: zG});
                grass.setAttribute('rotation', {x: 0, y: Math.random()*360, z: 0});
                container.appendChild(grass);
            }

            var stickCount = 10;
            for(var l=0; l<stickCount; l++) {
                var x = (Math.random() - 0.5) * 60;
                var z = (Math.random() - 0.5) * 60;
                if(!isForbidden(x,z)) {
                    var stick = document.createElement('a-entity');
                    stick.setAttribute('mixin', 'stickMixin');
                    stick.setAttribute('position', {x: x, y: 0.1, z: z});
                    stick.setAttribute('rotation', {x: 90, y: Math.random()*360, z: 0});
                    container.appendChild(stick);
                }
            }
        }

        function animateGnous() {
            var gnous = [
                document.querySelector('#gnou1'),
                document.querySelector('#gnou2'),
                document.querySelector('#gnou3'),
                document.querySelector('#gnou4'),
                document.querySelector('#gnou5')
            ];

            var t = 0;
            setInterval(function() {
                t += 0.02;
                gnous.forEach(function(g, index) {
                    if(g && g.object3D) {
                        var offset = index * (Math.PI * 2 / 5);
                        var r = 2.5 + (index % 2) * 1; 
                        var x = 4 + Math.cos(t * 0.5 + offset) * r;
                        var z = 4 + Math.sin(t * 0.5 + offset) * r;
                        g.object3D.position.set(x, 0, z);
                        var angle = t * 0.5 + offset;
                        g.object3D.rotation.y = -angle;
                    }
                });
            }, 50);
        }

        window.addEventListener('load', function () {
            createRain();
            createVegetation();
            animateGnous(); 
        });
    </script>
</body>
</html>
