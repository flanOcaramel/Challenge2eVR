<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>La Prairie Pluvieuse - VR</title>
    <meta name="description" content="Environnement VR immersif avec physique">

    <!-- 1. IMPORT A-FRAME & LIBRARIES -->
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <!-- A-Frame Extras (Animation, Controls, etc.) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/MozillaReality/ammo.js@8bbc0ea/builds/ammo.wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>

    <!-- Teleport Controls -->
    <script src="https://cdn.jsdelivr.net/gh/fernsroth/aframe-teleport-controls@master/dist/aframe-teleport-controls.min.js"></script>

    <!-- Custom User Scripts -->
    <script src="./assets/js/christmas-utils.js"></script>

    <script>
        // Configuration simple pour la pluie (sera lancée plus bas)
        AFRAME.registerComponent('rain-drop', {
            init: function() {
                this.reset();
            },
            tick: function() {
                this.el.object3D.position.y -= 0.1;
                if (this.el.object3D.position.y < 0) {
                    this.reset();
                }
            },
            reset: function() {
                // Position aléatoire autour du joueur (zone 20x20)
                var x = (Math.random() - 0.5) * 20;
                var z = (Math.random() - 0.5) * 20;
                var y = 10 + Math.random() * 5;
                this.el.object3D.position.set(x, y, z);
            }
        });
    </script>
</head>
<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
            <h2>Connexion à Challenge2eVR</h2>
            <form id="loginForm">
                <select id="username" required style="display: block; margin: 10px 0; padding: 10px; width: 220px;">
                    <option value="">Select Username</option>
                </select><br>
                <input type="password" id="password" placeholder="Password" required style="display: block; margin: 10px 0; padding: 10px; width: 200px;"><br>
                <button type="submit" style="padding: 10px 20px;">Login</button>
            </form>
            <div id="loginMessage" style="margin-top: 10px; color: red;"></div>
        </div>
    </div>

    <!-- VR Scene will be added here after login -->

    <!-- Login Script -->
    <script>
        // Load usernames from DB
        fetch('https://selles-francesconi.sio-chopin.fr/Challenge2e/public/index.php?page=api_usernames')
            .then(response => response.json())
            .then(usernames => {
                const select = document.getElementById('username');
                usernames.forEach(username => {
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = username;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading usernames:', error));

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const message = document.getElementById('loginMessage');

            fetch('https://selles-francesconi.sio-chopin.fr/Challenge2e/public/index.php?page=api_login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Load avatar
                    const avatar = data.avatar;
                    const modelId = avatar.model.replace('.glb', 'Model');

                    // Check world
                    const world = data.world;
                    if (world.name.toLowerCase().includes('prairie')) {
                        // Load prairie world
                        document.getElementById('loginOverlay').style.display = 'none';
                        loadVRScene(modelId);
                    } else {
                        // Redirect to another world
                        window.location.href = world.url;
                    }
                } else {
                    message.textContent = data.message;
                }
            })
            .catch(error => {
                message.textContent = 'Error connecting to server.';
                console.error(error);
            });
        });
    </script>

    <script>
        function loadVRScene(avatarModelId) {
            // Create the a-scene element dynamically
            const scene = document.createElement('a-scene');
            scene.id = 'vrScene';
            scene.setAttribute('physics', 'driver: ammo; debug: false; gravity: -9.8');
            scene.setAttribute('renderer', 'antialias: true; colorManagement: true;');
            scene.innerHTML = `
                <!-- 2. ASSETS -->
                <a-assets>
                    <!-- Texture Sol Réaliste (CDN Three.js) -->
                    <img id="grassTexture" src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/terrain/grasslight-big.jpg">

                    <!-- Modèles 3D -->
                    <a-asset-item id="grassModel" src="./assets/models/Grass.glb"></a-asset-item>
                    <a-asset-item id="barnModel" src="./assets/models/wooden_barn.glb"></a-asset-item>
                    <a-asset-item id="fenceModel" src="./assets/models/fence.glb"></a-asset-item>
                    <a-asset-item id="wildebeestModel" src="./assets/models/wildebeest.glb"></a-asset-item>
                    <a-asset-item id="treeModel" src="./assets/models/Tree.glb"></a-asset-item>
                    <a-asset-item id="bushModel" src="./assets/models/bush.glb"></a-asset-item>
                    <a-asset-item id="stickModel" src="./assets/models/Stick.glb"></a-asset-item>
                    <a-asset-item id="crateModel" src="./assets/models/Crate.glb"></a-asset-item>
                    <a-asset-item id="hatModel" src="./assets/models/hat.glb"></a-asset-item>
                    <a-asset-item id="sunModel" src="./assets/models/Sun.glb"></a-asset-item>
                    <a-asset-item id="chatModel" src="./assets/models/chat.glb"></a-asset-item>
                    <a-asset-item id="swingModel" src="./assets/models/balancoire.glb"></a-asset-item>

                    <!-- Avatar Models -->
                    <a-asset-item id="aventurierModel" src="./assets/models/aventurier.glb"></a-asset-item>
                    <a-asset-item id="astronauteModel" src="./assets/models/astronaute.glb"></a-asset-item>
                    <a-asset-item id="fitnessModel" src="./assets/models/fitness.glb"></a-asset-item>
                    <a-asset-item id="sharkModel" src="./assets/models/shark.glb"></a-asset-item>
                    <a-asset-item id="pugModel" src="./assets/models/pug.glb"></a-asset-item>

                    <!-- Mixins Physiques & Interactions -->
                    <!-- Objet attrapable standard -->
                    <a-mixin id="grabbable"
                        movement="type: grabbable; stickiness: stickable"
                        ammo-shape="type: hull"
                        ammo-body="type: dynamic; mass: 1">
                    </a-mixin>

                    <a-mixin id="grassMixin" gltf-model="#grassModel" scale="0.1 0.1 0.1"></a-mixin>

                    <a-mixin id="stickMixin"
                        gltf-model="#stickModel"
                        scale="1 1 1"
                        mixin="grabbable">
                    </a-mixin>

                    <a-mixin id="hatMixin"
                        gltf-model="#hatModel"
                        scale="1 1 1"
                        mixin="grabbable">
                    </a-mixin>

                    <!-- Mixins Christmas (Image User) -->
                    <a-mixin id="coal" material="color:black"
                             geometry="primitive:sphere; segments-height:7; segments-width:13; radius:0.04"
                             movement="type:grabbable; stickiness:stickable"
                             ammo-shape="type:sphere; fit:manual; sphereRadius:0.04"
                             ammo-body="type:dynamic; mass:0.1">
                    </a-mixin>
                    <a-mixin id="branch" material="color:#5C4033"
                             geometry="primitive:branch" scale="0.2 0.2 0.2"
                             movement="type:grabbable; stickiness:stickable"
                             ammo-shape="type:hull"
                             ammo-body="type:dynamic; mass:0.1">
                    </a-mixin>

                    <!-- Mixin Arbre (Décor) -->
                    <a-mixin id="treeMixin"
                        gltf-model="#treeModel"
                        scale="3 3 3"
                        ammo-body="type: static"
                        ammo-shape="type: cylinder">
                    </a-mixin>
        <!-- Enclos (Fence) -->
        <a-entity position="10 0 -15" id="enclosArea">
            <!-- Façade -->
            <a-entity gltf-model="#fenceModel" position="0 0 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="4 0 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="8 0 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <!-- Arrière -->
            <a-entity gltf-model="#fenceModel" position="0 0 8" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="4 0 8" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="8 0 8" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <!-- Côtés -->
            <a-entity gltf-model="#fenceModel" position="-2 0 2" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="-2 0 6" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="10 0 2" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            <a-entity gltf-model="#fenceModel" position="10 0 6" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
            
            <!-- 6 Gnous (Wildebeests) -->
            <a-entity id="gnou1" gltf-model="#wildebeestModel" position="4 0 4" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 0.8"></a-entity>
            <a-entity id="gnou2" gltf-model="#wildebeestModel" position="5 0 5" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 0.9"></a-entity>
            <a-entity id="gnou3" gltf-model="#wildebeestModel" position="3 0 5" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 0.85"></a-entity>
            <a-entity id="gnou4" gltf-model="#wildebeestModel" position="6 0 3" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 0.75"></a-entity>
            <a-entity id="gnou5" gltf-model="#wildebeestModel" position="2 0 4" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 1.0"></a-entity>
            <a-entity id="gnou6" gltf-model="#wildebeestModel" position="4 0 2" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 0.95"></a-entity>
        </a-entity>

                    <!-- Mixin Bush (Petit buisson) -->
                    <a-mixin id="bushMixin"
                        gltf-model="#bushModel"
                        scale="0.02 0.02 0.02"
                        ammo-body="type: static"
                        ammo-shape="type: box">
                    </a-mixin>
                </a-assets>

                <!-- 3. ENVIRONNEMENT -->
                <!-- Ciel Ensoleillé (Bleu pur) -->
                <a-sky color="#87CEEB"></a-sky>

                <!-- Soleil -->
                <a-entity gltf-model="#sunModel" position="-20 50 -30" scale="5 5 5"></a-entity>

                <!-- Lumière -->
                <a-entity light="type: ambient; color: #FFF; intensity: 0.7"></a-entity>
                <a-entity light="type: directional; color: #FFF; intensity: 1; castShadow: false" position="-1 1 0.5"></a-entity>

                <a-plane
                    src="#grassTexture"
                    rotation="-90 0 0"
                    width="100"
                    height="100"
                    repeat="20 20"
                    material="roughness: 1; metalness: 0"
                    ammo-body="type: static"
                    ammo-shape="type: box">
                </a-plane>

                <!-- 4. ÉLÉMENTS SCÉNIQUES -->
                <!-- Hangar -->
                <a-entity gltf-model="#barnModel" position="-10 0 -15" scale="2 2 2"
                    ammo-body="type: static"
                    ammo-shape="type: box; fit: manual; halfExtents: 5 4 5; offset: 0 4 0">
                </a-entity>

                <!-- Balançoire (Devant la maison) -->
                <a-entity gltf-model="#swingModel" position="-10 0 -5" rotation="0 180 0" scale="0.017 0.017 0.017"
                     ammo-body="type: static" ammo-shape="type: hull"></a-entity>

                <!-- Enclos (Fence) -->
                <a-entity position="10 0 -15" id="enclosArea">
                    <!-- Façade -->
                    <a-entity gltf-model="#fenceModel" position="0 0 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
                    <a-entity gltf-model="#fenceModel" position="4 0 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
                    <a-entity gltf-model="#fenceModel" position="8 0 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
                    <!-- Arrière -->
                    <a-entity gltf-model="#fenceModel" position="0 0 8" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
                    <a-entity gltf-model="#fenceModel" position="4 0 8" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
                    <a-entity gltf-model="#fenceModel" position="8 0 8" rotation="0 180 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
                    <!-- Côtés -->
                    <a-entity gltf-model="#fenceModel" position="-2 0 2" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
                    <a-entity gltf-model="#fenceModel" position="-2 0 6" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
                    <a-entity gltf-model="#fenceModel" position="10 0 2" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>
                    <a-entity gltf-model="#fenceModel" position="10 0 6" rotation="0 90 0" ammo-body="type: static" ammo-shape="type: box; fit: manual; halfExtents: 2 1 0.2"></a-entity>

                    <!-- 5 Gnous (Wildebeests) -->
                    <a-entity id="gnou1" gltf-model="#wildebeestModel" position="4 0 4" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 1.0"></a-entity>
                    <a-entity id="gnou2" gltf-model="#wildebeestModel" position="5 0 5" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 0.9"></a-entity>
                    <a-entity id="gnou3" gltf-model="#wildebeestModel" position="3 0 5" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 1.1"></a-entity>
                    <a-entity id="gnou4" gltf-model="#wildebeestModel" position="5 0 3" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 1.05"></a-entity>
                    <a-entity id="gnou5" gltf-model="#wildebeestModel" position="3 0 3" scale="0.7 0.7 0.7" animation-mixer="clip: wildebeest_male|wildebeest_walk_fwd; loop: repeat; timeScale: 0.95"></a-entity>
                </a-entity>

                <!-- Végétation & Loot -->
                <a-entity position="0 0 0" id="vegetation"></a-entity>

                <!-- LE CHAT -->
                <a-entity gltf-model="#chatModel" position="-12 0.50 -11" scale="0.02 0.02 0.02" rotation="0 45 0"
                          ammo-body="type: static" ammo-shape="type: hull"></a-entity>

                <!-- 5. LA CAISSE SPÉCIALE INTERACTIVE -->
                <a-entity position="-6 0 -11">
                    <!-- Caisse en bois -->
                    <a-entity gltf-model="#crateModel"
                        id="mainCrate"
                        scale="1 1 1"
                        ammo-body="type: static"
                        ammo-shape="type: box"
                        movement="type: static; stickiness: sticky"
                        position="0 0 0">
                    </a-entity>

                    <!-- Objets posés SUR la caisse -->
                    <a-entity mixin="hatMixin" position="0 1.0 0" scale="0.2 0.2 0.2"></a-entity>
                    <a-entity mixin="stickMixin" position="0.5 1.0 0.2" rotation="0 90 0"></a-entity>
                    <a-entity mixin="coal" position="-0.3 1.05 0.2"></a-entity>
                    <a-entity mixin="branch" position="0.3 1.02 -0.2" rotation="90 0 0"></a-entity>
                </a-entity>

                <!-- 6. JOUEUR (RIG CAMERA) -->
                <a-entity id="rig">
                    <a-camera id="camera" position="0 1.6 0" look-controls wasd-controls></a-camera>
                    <a-entity id="playerAvatar" gltf-model="#${avatarModelId}" position="0 -1.6 0" scale="0.5 0.5 0.5"></a-entity>
                    <a-entity id="lhand" hand-controls="hand: left" teleport-controls="cameraRig: #rig; teleportOrigin: #camera; collisionEntities: [ammo-shape]" visible="true"></a-entity>
                    <a-entity id="rhand" hand-controls="hand: right" visible="true"></a-entity>
                </a-entity>
            `;
            document.body.appendChild(scene);
            // Initialize the scene after adding
            setTimeout(() => {
                createRain();
                createVegetation();
                animateGnous();
            }, 100);
        }
    </script>

    <!-- Script de génération procédurale & Animation -->
    <script>
        // Génération Pluie
        function createRain() {
            var scene = document.querySelector('a-scene');
            var rainCount = 200; // OPTIMISATION : Grosses économies CPU/GPU
            for(var i=0; i<rainCount; i++) {
                var drop = document.createElement('a-entity');
                drop.setAttribute('geometry', 'primitive: box; height: 0.1; width: 0.01; depth: 0.01');
                drop.setAttribute('material', 'color: #AACCFF; opacity: 0.6; transparent: true');
                drop.setAttribute('rain-drop', '');
                scene.appendChild(drop);
            }
        }

        // Végétation (Arbres Decor & Bush Sol)
        function createVegetation() {
            var container = document.querySelector('#vegetation');

            // 1. ARBRES (Décor Naturel autour)
            // On veut une disposition aléatoire mais qui laisse le centre (Maison/Enclos) dégagé.
            // Centre approximatif de la zone de vie : x=0, z=-10
            var treeCount = 32;
            var trees = [];

            for(var i=0; i<treeCount; i++) {
                var valid = false, attempts = 0;
                var x, z;

                while(!valid && attempts < 50) {
                    // Zone large de 80x80
                    x = (Math.random() - 0.5) * 80;
                    z = (Math.random() - 0.5) * 80; // Centré autour de 0,0

                    // Calcul distance au centre de la zone de vie (0, -10)
                    var dist = Math.sqrt((x - 0)**2 + (z - -10)**2);

                    // REGLE : On veut les arbres LOIN du centre (> 25m) et pas trop proches les uns des autres
                    if(dist > 25) {
                        valid = true;
                        // Check anti-collision entre arbres
                        for(var t=0; t<trees.length; t++) {
                            if(Math.hypot(x-trees[t].x, z-trees[t].z) < 5) { valid = false; break; }
                        }
                    }
                    attempts++;
                }

                if(valid) {
                    trees.push({x:x, z:z});
                    var tree = document.createElement('a-entity');
                    tree.setAttribute('mixin', 'treeMixin');
                    // Scale augmenté ENCORE de 30% (Total: 1.69)
                    var s = (1.0 + Math.random() * 1.5) * 3;
                    // CORRECTION: position Y levée selon le scale (approx pivot centré)
                    tree.setAttribute('position', {x: x, y: s * 1, z: z});
                    tree.setAttribute('scale', {x: s, y: s, z: s});
                    tree.setAttribute('rotation', {x: 0, y: Math.random()*360, z: 0});
                    container.appendChild(tree);
                }
            }

            // 2. BUSHES (Buissons au sol aléatoires)
            // Ils peuvent être un peu plus proches, pour habiller le sol
            var bushCount = 80; // OPTIMISATION
            var isForbidden = function(x, z) {
                // Zone stricte maison/enclos pour ne pas clipper dedans
                // (x: -12 à 20, z: -20 à -5)
                return (x > -12 && x < 20 && z > -20 && z < -5);
            };

            for(var k=0; k<bushCount; k++) {
                var x = (Math.random() - 0.5) * 70;
                var z = (Math.random() - 0.5) * 70;

                if(!isForbidden(x,z)) {
                   var bush = document.createElement('a-entity');
                   bush.setAttribute('mixin', 'bushMixin');
                   bush.setAttribute('position', {x: x, y: 0, z: z});
                   // Scale augmenté car 0.02 était invisible.
                   // On tente 0.5 à 0.8
                   var s = 0.5 + Math.random() * 0.5;
                   bush.setAttribute('scale', {x: s, y: s, z: s});
                   bush.setAttribute('rotation', {x: 0, y: Math.random()*360, z: 0});
                   container.appendChild(bush);
                }
            }

            // 3. Herbe & Batons
            var grassCount = 150; // OPTIMISATION
            for(var j=0; j<grassCount; j++) {
                var angleG = Math.random() * Math.PI * 2;
                var radiusG = 2 + Math.random() * 45;
                var xG = Math.cos(angleG) * radiusG;
                var zG = Math.sin(angleG) * radiusG;
                var grass = document.createElement('a-entity');
                grass.setAttribute('mixin', 'grassMixin');
                grass.setAttribute('position', {x: xG, y: 0, z: zG});
                grass.setAttribute('rotation', {x: 0, y: Math.random()*360, z: 0});
                container.appendChild(grass);
            }

             // Batons (Loot)
             var stickCount = 10;
            for(var l=0; l<stickCount; l++) {
                var x = (Math.random() - 0.5) * 60;
                var z = (Math.random() - 0.5) * 60;
                if(!isForbidden(x,z)) {
                    var stick = document.createElement('a-entity');
                    stick.setAttribute('mixin', 'stickMixin');
                    stick.setAttribute('position', {x: x, y: 0.1, z: z}); // Pose au sol
                    stick.setAttribute('rotation', {x: 90, y: Math.random()*360, z: 0});
                    container.appendChild(stick);
                }
            }
        }

        // Animation Gnous (6) - INTELLIGENTE + ANTI_COLLISION
        function animateGnous() {
            var gnous = [
                { el: document.querySelector('#gnou1'), speed: 0.8, state: 'walk', waitTimer: 0, target: null },
                { el: document.querySelector('#gnou2'), speed: 0.6, state: 'walk', waitTimer: 0, target: null },
                { el: document.querySelector('#gnou3'), speed: 0.9, state: 'walk', waitTimer: 0, target: null },
                { el: document.querySelector('#gnou4'), speed: 0.7, state: 'walk', waitTimer: 0, target: null },
                { el: document.querySelector('#gnou5'), speed: 1.0, state: 'walk', waitTimer: 0, target: null },
                { el: document.querySelector('#gnou6'), speed: 0.85, state: 'walk', waitTimer: 0, target: null }
            ];

            // Limites strictes de l"enclos (0 à 8, 1 à 7)
            function getRandomPoint() {
                return {
                    x: Math.max(0.5, Math.min(7.5, Math.random() * 8)),
                    z: Math.max(1.5, Math.min(6.5, 1 + Math.random() * 6))
                };
            }

            // Init
            gnous.forEach(g => { 
                g.target = getRandomPoint();
                g.el.setAttribute('animation-mixer', 'clip: *walk*; loop: repeat; timeScale: 1.0');
            });

            var t = 0;
            function loop() {
                requestAnimationFrame(loop);
                
                // 1. Mouvement
                gnous.forEach(function(item) {
                     var g = item.el;
                     if(!g || !g.object3D) return;

                     var pos = g.object3D.position;

                     // Check Sortie Enclos (Sécurité)
                     if(pos.x < 0 || pos.x > 8 || pos.z < 1 || pos.z > 7) {
                         // Hors limites : Retourne au centre
                         pos.x = Math.max(0.1, Math.min(7.9, pos.x));
                         pos.z = Math.max(1.1, Math.min(6.9, pos.z));
                         item.target = getRandomPoint();
                     }

                     if(item.state === 'wait') {
                         item.waitTimer -= 0.016; 
                         if(item.waitTimer <= 0) {
                             item.state = 'walk';
                             item.target = getRandomPoint();
                             g.setAttribute('animation-mixer', 'timeScale', 1.0);
                         } else {
                             g.setAttribute('animation-mixer', 'timeScale', 0);
                         }
                     }
                     else if(item.state === 'walk') {
                        g.setAttribute('animation-mixer', 'timeScale', 1.0);

                        var dx = item.target.x - pos.x;
                        var dz = item.target.z - pos.z;
                        var dist = Math.sqrt(dx*dx + dz*dz);

                        if(dist < 0.2) {
                            item.state = 'wait';
                            item.waitTimer = 1.0 + Math.random() * 2.0; 
                        } else {
                            var moveStep = item.speed * 0.02;
                            pos.x += (dx / dist) * moveStep;
                            pos.z += (dz / dist) * moveStep;
                            
                            var angle = Math.atan2(dx, dz); 
                            g.object3D.rotation.y = angle + Math.PI; 
                        }
                     }
                });

                // 2. Anti-Collision Gnou vs Gnou
                for(var i=0; i<gnous.length; i++) {
                    for(var j=i+1; j<gnous.length; j++) {
                        var g1 = gnous[i];
                        var g2 = gnous[j];
                        if(!g1.el.object3D || !g2.el.object3D) continue;

                        var p1 = g1.el.object3D.position;
                        var p2 = g2.el.object3D.position;
                        var dist = Math.sqrt((p1.x - p2.x)**2 + (p1.z - p2.z)**2);

                        // Si trop proches (< 1.2m)
                        if(dist < 1.0) {
                            // On change leurs cibles immédiatement pour les éloigner
                            g1.target = getRandomPoint();
                            g2.target = getRandomPoint();
                            // Petit "rebond" pour décoller
                            var pushX = (p1.x - p2.x) * 0.05;
                            var pushZ = (p1.z - p2.z) * 0.05;
                            p1.x += pushX; p1.z += pushZ;
                            p2.x -= pushX; p2.z -= pushZ;
                        }
            setInterval(function() {
                t += 0.02;
                gnous.forEach(function(g, index) {
                    if(g && g.object3D) {
                        // Varie Rayon et Phase
                        var offset = index * (Math.PI * 2 / 5);
                        var r = 2.5 + (index % 2) * 1;

                        var x = 4 + Math.cos(t * 0.5 + offset) * r;
                        var z = 4 + Math.sin(t * 0.5 + offset) * r;

                        g.object3D.position.set(x, 0, z);
                        // Orientation: Regarder vers l'avant de la marche
                        // Tangente au cercle
                        var angle = t * 0.5 + offset;
                        // En A-Frame Rotation Y: 0 = -Z, 90 = -X...
                        // Angle maths: 0 = +X.
                        // Pour regarder "devant" sur le cercle trigonométrique (sens anti-horaire):
                        // Rotation = -Angle + PI (ou similaire).
                        // On ajuste expérimentalement si "à l'envers".
                        // Essayons Rotation Y = -Angle
                        g.object3D.rotation.y = -angle;
                    }
                }
            }
            loop(); 
        }

        // Lancement au chargement
        window.addEventListener('load', function () {
            // Do nothing here, wait for login
        });
    </script>
</body>
</html>