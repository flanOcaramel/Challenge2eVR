<!DOCTYPE html>
<html>
<head>
    <title>Challenge2e VR Carousel</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
</head>
<body>
    <a-scene>
        <a-camera position="0 1.6 0">
            <a-cursor raycaster="objects: .clickable"></a-cursor>
        </a-camera>

        <a-entity id="carousel" position="0 1.6 -3" rotation="0 0 0">
            <!-- Users will be added here dynamically -->
        </a-entity>

        <a-plane position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>


    </a-scene>

    <div id="password-overlay" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid black;">
        <p>Enter password for <span id="user-name"></span>:</p>
        <input type="password" id="password-input">
        <button id="submit-btn">Submit</button>
        <button id="cancel-btn">Cancel</button>
    </div>

    <script>
        let users = [];
        let selectedUser = null;

        // Fetch users from Challenge2e DB via API
        fetch('https://selles-francesconi.sio-chopin.fr/Challenge2e/public/api.php')
            .then(response => response.json())
            .then(data => {
                users = data;
                createCarousel();
            })
            .catch(error => {
                console.error('Error fetching users:', error);
                // Fallback to mock data
                users = [
                    { username: 'Alice', modelAvatar: 'adventurer.glb', nameWorld: 'Plaine', urlWorld: 'vr.html' },
                    { username: 'Bob', modelAvatar: 'astronaut.glb', nameWorld: 'Mer', urlWorld: 'http://example.com/mer' },
                    { username: 'Charlie', modelAvatar: 'pug.glb', nameWorld: 'Plaine', urlWorld: 'vr.html' }
                ];
                createCarousel();
            });

        function createCarousel() {
            const carousel = document.getElementById('carousel');
            const radius = 3;
            const angleStep = (2 * Math.PI) / users.length;

            users.forEach((user, index) => {
                const angle = index * angleStep;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                const userEntity = document.createElement('a-entity');
                userEntity.setAttribute('position', `${x} 0 ${z}`);
                userEntity.setAttribute('look-at', '0 1.6 0');

                // Avatar 3D
                const avatar = document.createElement('a-gltf-model');
                avatar.setAttribute('src', `assets/models/${user.modelAvatar}`);
                avatar.setAttribute('scale', '0.5 0.5 0.5');
                userEntity.appendChild(avatar);

                // Name text
                const nameText = document.createElement('a-text');
                nameText.setAttribute('value', user.username);
                nameText.setAttribute('position', '0 1 0');
                nameText.setAttribute('align', 'center');
                userEntity.appendChild(nameText);

                // Make clickable
                userEntity.setAttribute('class', 'clickable');
                userEntity.addEventListener('click', () => selectUser(user));

                carousel.appendChild(userEntity);
            });
        }

        function selectUser(user) {
            selectedUser = user;
            if (user.nameWorld !== 'Plaine') {
                window.location.href = user.urlWorld;
            } else {
                showPasswordPrompt();
            }
        }

        function showPasswordPrompt() {
            document.getElementById('user-name').textContent = selectedUser.username;
            document.getElementById('password-overlay').style.display = 'block';
        }

        document.getElementById('submit-btn').addEventListener('click', () => {
            const password = document.getElementById('password-input').value;
            fetch('https://selles-francesconi.sio-chopin.fr/Challenge2e/public/login.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: selectedUser.username, password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = 'https://selles-francesconi.sio-chopin.fr/Challenge2eVR/vr.html';
                } else {
                    alert('Incorrect password');
                }
            })
            .catch(error => {
                console.error('Login error:', error);
                alert('Login service unavailable');
            });
        });

        document.getElementById('cancel-btn').addEventListener('click', () => {
            document.getElementById('password-overlay').style.display = 'none';
            document.getElementById('password-input').value = '';
        });

        // For carousel rotation
        document.addEventListener('keydown', (e) => {
            const carousel = document.getElementById('carousel');
            let rotation = carousel.getAttribute('rotation');
            if (e.key === 'ArrowLeft') {
                rotation.y += 10;
            } else if (e.key === 'ArrowRight') {
                rotation.y -= 10;
            }
            carousel.setAttribute('rotation', rotation);
        });

        // Mouse drag to rotate carousel
        let isDragging = false;
        let previousMouseX = 0;

        document.addEventListener('mousedown', (e) => {
            isDragging = true;
            previousMouseX = e.clientX;
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - previousMouseX;
                const carousel = document.getElementById('carousel');
                let rotation = carousel.getAttribute('rotation');
                rotation.y += deltaX * 0.5; // Sensitivity
                carousel.setAttribute('rotation', rotation);
                previousMouseX = e.clientX;
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
    </script>
</body>
</html>